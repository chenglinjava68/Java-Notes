#### 事务的启动时机

`begin/start transaction`命令并不是一个事务的的起点，在执行到它们之后的第一个操作InnoDB表的语句，事务才真正启动。如果想马上启动一个事务，可以使用`start transaction with consistent snapshot`命令。

InnoDB里面每个事务都有一个事务ID，叫做transaction id。在事务开始的时候向InnoDB事务系统申请，按**申请顺序严格递增**。

InnoDB为每个事务构造了一个数组，用来保存这个事务启动瞬间，当前正在“活跃”的所有事务id，活跃是指事务**启动了但是还没提交**。

现在有一个表，初始化语句如下：

~~~mysql
mysql> CREATE TABLE `t` (
`id` int(11) NOT NULL,
`k` int(11) DEFAULT NULL,
PRIMARY KEY (`id`)
) ENGINE=InnoDB;
insert into t(id, k) values(1,1),(2,2);
~~~

分别开启三个窗口，有如下表3个事务

| 事务A                                      | 事务B                                                        | 事务C                         |
| :----------------------------------------- | ------------------------------------------------------------ | ----------------------------- |
| start transaction with consistent snapshot |                                                              |                               |
|                                            | start transaction with consistent snapshot                   |                               |
|                                            |                                                              | update t set k=k+1 where id=1 |
|                                            | update t set k=k+1 where id=1;select k from t where       id =1 |                               |
| select k from t where id=1;commit          |                                                              |                               |
|                                            | commit;                                                      |                               |

事务C没有显示开启事务，说明它本身就是一个事务，语句完成时会自动提交。事务A中查询到的结果是k=1，而事务B中查询到的结果是k=3，下面是执行结果

在事务B中：

~~~mysql
mysql> start transaction with consistent snapshot;
Query OK, 0 rows affected (0.00 sec)

mysql> select * from t //在执行更新语句之前查询，此时得到的值仍然是1
    -> ;
+----+------+
| id | k    |
+----+------+
|  1 |    1 |
|  2 |    2 |
+----+------+
2 rows in set (0.00 sec)

mysql> update t set k=k+1 where id=1; 
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

mysql> select k from t where id=1;
+------+
| k    |
+------+
|    3 |
+------+
1 row in set (0.00 sec)

mysql> commit;
Query OK, 0 rows affected (0.04 sec)

mysql> select k from t where id=1;
+------+
| k    |
+------+
|    3 |
+------+
1 row in set (0.00 sec)

mysql>
~~~

然后是事务A:

~~~mysql
mysql> start transaction with consistent snapshot;
Query OK, 0 rows affected (0.00 sec)

mysql> select k from t where id=1;
+------+
| k    |
+------+
|    1 |
+------+
1 row in set (0.00 sec)

mysql> commit;
Query OK, 0 rows affected (0.00 sec)

mysql> select k from t where id=1; //事务A提交后变为2，此时事务B未提交
+------+
| k    |
+------+
|    2 |
+------+
1 row in set (0.00 sec)

mysql> select k from t where id=1; //事务B提交后，查询得到的值为3
+------+
| k    |
+------+
|    3 |
+------+
1 row in set (0.00 sec)

mysql>
~~~

